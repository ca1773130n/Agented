---
phase: 01-web-ui-roadmapping-feature
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - frontend/src/views/ProjectPlanningPage.vue
  - frontend/src/components/grd/PlanningCommandBar.vue
  - frontend/src/components/grd/PlanningSessionPanel.vue
  - frontend/src/components/grd/MilestoneOverview.vue
autonomous: true
verification_level: proxy

must_haves:
  truths:
    - "ProjectPlanningPage renders with split layout: MilestoneOverview on left, AI session panel on right"
    - "PlanningCommandBar groups 17 GRD planning commands into 4 categories with action buttons"
    - "PlanningSessionPanel displays streaming AI output with markdown rendering and interactive question widgets"
    - "Clicking a command button in PlanningCommandBar invokes the corresponding GRD command via usePlanningSession"
    - "MilestoneOverview is extended with per-phase action buttons for phase-scoped GRD commands"
    - "Session output is rendered as markdown via marked + dompurify (not raw pre text)"
    - "Interactive questions show option selection widgets when question events arrive"
  artifacts:
    - path: "frontend/src/views/ProjectPlanningPage.vue"
      provides: "Main planning page with split layout, data loading, command dispatch"
      min_lines: 200
    - path: "frontend/src/components/grd/PlanningCommandBar.vue"
      provides: "Categorized GRD command buttons with command dispatch"
      min_lines: 80
    - path: "frontend/src/components/grd/PlanningSessionPanel.vue"
      provides: "AI session output panel with markdown rendering and question widgets"
      min_lines: 150
  key_links:
    - from: "frontend/src/views/ProjectPlanningPage.vue"
      to: "frontend/src/composables/usePlanningSession.ts"
      via: "import and composable usage"
      pattern: "import.*usePlanningSession.*from"
    - from: "frontend/src/views/ProjectPlanningPage.vue"
      to: "frontend/src/components/grd/MilestoneOverview.vue"
      via: "component import and rendering"
      pattern: "import.*MilestoneOverview.*from"
    - from: "frontend/src/components/grd/PlanningSessionPanel.vue"
      to: "frontend/src/composables/usePlanningSession.ts"
      via: "props receiving composable state"
      pattern: "outputLines|currentQuestion|status"
    - from: "frontend/src/views/ProjectPlanningPage.vue"
      to: "frontend/src/services/api/grd.ts"
      via: "API calls for milestones, phases, plans"
      pattern: "grdApi"
---

<objective>
Build the ProjectPlanningPage view and its child components — the primary user-facing UI for GRD project planning.

Purpose: This is the core deliverable of Phase 1. Users interact with this page to invoke GRD planning commands, view AI session output, answer interactive questions, and monitor milestone/phase/plan state — all from the browser without CLI access.

Output: `ProjectPlanningPage.vue` (split-layout view), `PlanningCommandBar.vue` (command categories), `PlanningSessionPanel.vue` (AI output + interaction), extended `MilestoneOverview.vue` (phase action buttons).
</objective>

<execution_context>
@.planning/milestones/v0.1.0/phases/01-web-ui-roadmapping-feature/01-CONTEXT.md
@.planning/milestones/v0.1.0/phases/01-web-ui-roadmapping-feature/01-RESEARCH.md
@frontend/src/views/ProjectManagementPage.vue
@frontend/src/views/SuperAgentPlayground.vue
@frontend/src/components/grd/MilestoneOverview.vue
@frontend/src/components/projects/InteractiveSetup.vue
@frontend/src/composables/usePlanningSession.ts
@frontend/src/services/api/grd.ts
</execution_context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProjectPlanningPage with split layout and data loading</name>
  <files>frontend/src/views/ProjectPlanningPage.vue</files>
  <action>
    Create `frontend/src/views/ProjectPlanningPage.vue` as the main planning page view.

    **Layout** (per CONTEXT.md locked decisions and Specific Ideas):
    - Split layout with two panels side by side, matching the `kanban-chat-layout` pattern from `ProjectManagementPage.vue`.
    - **Left panel** (~60% width, scrollable): MilestoneOverview at top showing milestone stats and phase cards, PlanningCommandBar below it.
    - **Right panel** (~40% width, fixed): PlanningSessionPanel showing AI session output and interaction widgets.
    - The right panel should be collapsible/hideable when no session is active (similar to how `showChatPanel` works in ProjectManagementPage).

    **Script setup** (`<script setup lang="ts">`):

    1. **Props**: `projectId?: string` (same pattern as ProjectManagementPage).
    2. **Route**: Extract `projectId` from route params or props via computed.
    3. **Data loading** (onMounted):
       - Fetch project via `projectApi.get(projectId)`.
       - Fetch milestones via `grdApi.listMilestones(projectId)`.
       - Fetch phases via `grdApi.listPhases(projectId)`.
       - Fetch plans via `grdApi.listPlans(projectId)`.
       - Fetch planning status via `grdApi.getPlanningStatus(projectId)` to get `grd_init_status`.
    4. **Planning session** (composable):
       - `const planning = usePlanningSession(computed(() => projectId.value))`.
       - Expose `planning.invokeCommand`, `planning.sendAnswer`, `planning.stopSession`.
    5. **Command dispatch**:
       - `handleInvokeCommand(command: string, args?: Record<string, string>)`: calls `planning.invokeCommand(command, args)`, shows right panel.
       - Watch `planning.status` — when `'complete'`, trigger data refresh (re-fetch milestones/phases/plans + sync via `grdApi.sync(projectId)`). This implements the session-completion refresh from CONTEXT.md.
    6. **Phase-scoped commands**:
       - `handlePhaseCommand(phaseNumber: number, command: string)`: calls `handleInvokeCommand(command, { phase: String(phaseNumber) })`.
    7. **Breadcrumbs**: Projects > {project.name} > Planning (same pattern as ProjectManagementPage).

    **Template**:
    ```html
    <AppBreadcrumb :crumbs="breadcrumbs" />
    <PageHeader :title="'Planning'" :subtitle="project?.name" />

    <div class="planning-layout">
      <div class="planning-left">
        <MilestoneOverview
          :milestone="selectedMilestone"
          :phases="filteredPhases"
          :plans="filteredPlans"
          @createPhase="handleCreatePhase"
          @phaseCommand="handlePhaseCommand"
        />
        <PlanningCommandBar
          :status="planning.status.value"
          :grd-init-status="grdInitStatus"
          @invoke="handleInvokeCommand"
        />
      </div>
      <div class="planning-right" v-if="showSessionPanel">
        <PlanningSessionPanel
          :output-lines="planning.outputLines.value"
          :status="planning.status.value"
          :current-question="planning.currentQuestion.value"
          :exit-code="planning.exitCode.value"
          @send-answer="planning.sendAnswer"
          @stop="planning.stopSession"
          @clear="handleClearSession"
        />
      </div>
    </div>
    ```

    **Styles** (scoped):
    - `.planning-layout`: `display: flex; gap: 16px; height: calc(100vh - 140px);`
    - `.planning-left`: `flex: 1; overflow-y: auto; min-width: 0;`
    - `.planning-right`: `width: 420px; flex-shrink: 0; display: flex; flex-direction: column;`
    - Follow the dark theme CSS custom properties from `App.vue` (background colors, borders, text colors).
    - Use the existing `--bg-secondary`, `--bg-tertiary`, `--text-primary`, `--text-secondary`, `--border-color` variables.

    Use `useToast()` for error notifications. Import `AppBreadcrumb`, `PageHeader`, `EntityLayout` following existing view patterns.
  </action>
  <verify>
    cd frontend && npx vue-tsc --noEmit && npm run build
    Navigate to /projects/{id}/planning in dev — page renders without console errors
    (Level 2: Proxy — page renders and displays milestone data)
  </verify>
  <done>ProjectPlanningPage.vue renders with split layout, loads milestone/phase/plan data, dispatches GRD commands via usePlanningSession, refreshes data on session completion.</done>
</task>

<task type="auto">
  <name>Task 2: Create PlanningCommandBar, PlanningSessionPanel, and extend MilestoneOverview</name>
  <files>frontend/src/components/grd/PlanningCommandBar.vue, frontend/src/components/grd/PlanningSessionPanel.vue, frontend/src/components/grd/MilestoneOverview.vue</files>
  <action>
    **Component 1: PlanningCommandBar.vue** (`frontend/src/components/grd/PlanningCommandBar.vue`)

    A categorized command panel that groups all 17 GRD planning commands into 4 workflow categories (per RESEARCH.md recommendations):

    Props:
    - `status: 'idle' | 'running' | 'waiting_input' | 'complete' | 'error'` — disables buttons when session is running
    - `grdInitStatus: string` — shows init status indicator

    Emits:
    - `invoke(command: string, args?: Record<string, string>)` — when a command button is clicked

    Command categories (defined as const array in script):
    ```typescript
    const commandGroups = [
      {
        label: 'Project Setup',
        commands: [
          { name: 'map-codebase', label: 'Map Codebase', description: 'Analyze project structure' },
          { name: 'new-milestone', label: 'New Milestone', description: 'Create a new milestone' },
          { name: 'long-term-roadmap', label: 'Long-term Roadmap', description: 'Generate strategic roadmap' },
        ],
      },
      {
        label: 'Phase Management',
        commands: [
          { name: 'add-phase', label: 'Add Phase', description: 'Add a phase to milestone' },
          { name: 'remove-phase', label: 'Remove Phase', description: 'Remove a phase' },
          { name: 'insert-phase', label: 'Insert Phase', description: 'Insert phase at position' },
          { name: 'discuss-phase', label: 'Discuss Phase', description: 'AI-assisted phase discussion' },
          { name: 'plan-phase', label: 'Plan Phase', description: 'Generate execution plans' },
        ],
      },
      {
        label: 'Research & Analysis',
        commands: [
          { name: 'survey', label: 'Survey', description: 'Survey research landscape' },
          { name: 'deep-dive', label: 'Deep Dive', description: 'Deep dive into topic' },
          { name: 'feasibility', label: 'Feasibility', description: 'Assess feasibility' },
          { name: 'assess-baseline', label: 'Assess Baseline', description: 'Establish performance baseline' },
          { name: 'compare-methods', label: 'Compare Methods', description: 'Compare approaches' },
          { name: 'list-phase-assumptions', label: 'List Assumptions', description: 'Surface phase assumptions' },
        ],
      },
      {
        label: 'Requirements',
        commands: [
          { name: 'requirement', label: 'Requirement', description: 'Define a requirement' },
          { name: 'plan-milestone-gaps', label: 'Plan Gaps', description: 'Identify milestone gaps' },
          { name: 'complete-milestone', label: 'Complete Milestone', description: 'Mark milestone complete' },
        ],
      },
    ];
    ```

    Template: Render each group as a section with label header and grid of command buttons. Each button shows `command.label` and on click emits `invoke(command.name)`. Disable all buttons when `status !== 'idle'` (session running). Show a subtle status indicator based on `grdInitStatus`.

    Styles: Use the dark theme card pattern. Command buttons as compact action buttons with hover state. Group labels in `--text-secondary` color.

    **Component 2: PlanningSessionPanel.vue** (`frontend/src/components/grd/PlanningSessionPanel.vue`)

    The AI session output panel with markdown rendering and interactive question widgets.

    Props:
    - `outputLines: string[]` — raw text lines from the PTY session
    - `status: 'idle' | 'running' | 'waiting_input' | 'complete' | 'error'`
    - `currentQuestion: PlanningQuestion | null`
    - `exitCode: number | null`

    Emits:
    - `sendAnswer(answer: string)` — when user submits an answer
    - `stop()` — when user clicks stop button
    - `clear()` — when user clicks clear button

    Implementation:
    1. **Output rendering**: Join `outputLines` and render via `marked` + `dompurify` (import from existing `useMarkdown` composable or use directly). Use `streaming-markdown` if incremental rendering is needed, but for simplicity start with batched rendering on a computed that re-renders when `outputLines` changes. Wrap in a scrollable `<div>` with auto-scroll to bottom (use `useAutoScroll` composable if it exists, otherwise implement with `scrollTop = scrollHeight` on nextTick after outputLines change).
    2. **Question widget**: When `currentQuestion` is non-null, show an interaction widget below the output:
       - For `question_type === 'select'`: Render clickable option buttons (one per option). On click, emit `sendAnswer(selectedOption)`.
       - For `question_type === 'multiselect'`: Render checkboxes for each option with a Submit button.
       - For `question_type === 'text'` or `'password'`: Render a text input with a Send button. On Enter key, emit `sendAnswer(inputValue)`.
       - Show the `prompt` text above the widget.
    3. **Status bar**: Show session status at top of panel. When `status === 'running'`, show a pulsing indicator. When `status === 'complete'`, show exit code. When `status === 'error'`, show error state.
    4. **Action buttons**: Stop button (visible when running), Clear button (visible when complete/error).

    Follow the styling patterns from `InteractiveSetup.vue` for question widgets and from `AiChatPanel.vue` for message rendering.

    **Component 3: Extend MilestoneOverview.vue** (`frontend/src/components/grd/MilestoneOverview.vue`)

    Add per-phase action buttons for phase-scoped GRD commands. This is an extension to the existing component.

    Changes:
    1. Add a new emit: `phaseCommand(phaseNumber: number, command: string)`.
    2. In the phase card rendering (the section that iterates over phases), add a small actions area with 3 compact buttons per phase:
       - "Discuss" → emits `phaseCommand(phase.phase_number, 'discuss-phase')`
       - "Plan" → emits `phaseCommand(phase.phase_number, 'plan-phase')`
       - "Research" → emits `phaseCommand(phase.phase_number, 'research-phase')`
    3. These buttons should be small, secondary-styled, and only visible on hover over the phase card (CSS `:hover` reveal pattern) to avoid cluttering the overview.
    4. Do NOT remove or change any existing functionality — only ADD the new emit and action buttons.

    AVOID: Do NOT use `@vue-flow/core` or any graph visualization library — that is deferred per CONTEXT.md.
  </action>
  <verify>
    cd frontend && npm run build
    (Level 1: Sanity — build passes including vue-tsc type checking)

    Navigate to /projects/{id}/planning in dev:
    - MilestoneOverview shows milestone data with phase cards
    - PlanningCommandBar shows 4 command groups with 17 command buttons
    - Clicking a command button shows the session panel (right side) with loading state
    (Level 2: Proxy — UI renders and commands dispatch)
  </verify>
  <done>
    PlanningCommandBar renders 17 GRD commands in 4 categories. PlanningSessionPanel renders streaming output as markdown with question widgets. MilestoneOverview has per-phase action buttons. All components render without errors. Build passes.
  </done>
</task>

</tasks>

<verification>
Level 1 (Sanity):
- `just build` succeeds (vue-tsc + vite build)
- `cd frontend && npm run test:run` passes (no regressions)

Level 2 (Proxy):
- Navigate to `/projects/{id}/planning` — page renders with split layout
- MilestoneOverview shows milestone data with phase cards and action buttons
- PlanningCommandBar shows 4 grouped command sections
- Clicking a command dispatches via usePlanningSession (check network tab for POST to /planning/invoke)
- Session panel shows streaming output when a session is active

Level 3 (Deferred):
- End-to-end test of each of the 17 GRD planning commands
- Interactive question/answer round-trip with actual GRD session
</verification>

<success_criteria>
ProjectPlanningPage renders with split layout showing MilestoneOverview and PlanningSessionPanel. PlanningCommandBar lists all 17 planning commands grouped into 4 categories. Commands dispatch via usePlanningSession composable. Session output renders as markdown. Interactive questions show option widgets. Build and existing tests pass.
</success_criteria>

<output>
After completion, create `.planning/milestones/v0.1.0/phases/01-web-ui-roadmapping-feature/01-03-SUMMARY.md`
</output>
