---
phase: 02-environment-and-wsgi-foundation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - backend/.env.example
  - justfile
  - deploy/agented.service
  - deploy/com.agented.backend.plist
autonomous: true
verification_level: sanity

must_haves:
  truths:
    - "`just deploy` starts Gunicorn (not python run.py) and ps shows gunicorn worker process"
    - ".env.example documents all environment variables discovered in the codebase with types, defaults, and descriptions"
    - "systemd unit file (deploy/agented.service) specifies Restart=on-failure and RestartSec<=5"
    - "launchd plist (deploy/com.agented.backend.plist) specifies KeepAlive=true for automatic restart"
    - "A fresh clone copying .env.example to .env reaches a runnable state"
  artifacts:
    - path: "backend/.env.example"
      provides: "Documented environment variable template"
      contains: "SECRET_KEY"
    - path: "justfile"
      provides: "Updated deploy target using Gunicorn"
      contains: "gunicorn"
    - path: "deploy/agented.service"
      provides: "systemd unit file for Linux deployment"
      contains: "Restart=on-failure"
    - path: "deploy/com.agented.backend.plist"
      provides: "launchd plist for macOS deployment"
      contains: "KeepAlive"
  key_links:
    - from: "justfile"
      to: "backend/gunicorn.conf.py"
      via: "deploy target invokes gunicorn -c gunicorn.conf.py"
      pattern: "gunicorn.*-c.*gunicorn.conf.py"
    - from: "deploy/agented.service"
      to: "backend/gunicorn.conf.py"
      via: "ExecStart invokes gunicorn with config file"
      pattern: "gunicorn.*-c.*gunicorn.conf.py"
    - from: "backend/.env.example"
      to: "backend/app/__init__.py"
      via: "Documents SECRET_KEY, CORS_ALLOWED_ORIGINS used by create_app()"
      pattern: "SECRET_KEY"
---

<objective>
Create .env.example documentation, update the justfile deploy target to use Gunicorn, and add process supervisor configurations for both systemd (Linux) and launchd (macOS).

Purpose: Wire the Gunicorn + gevent foundation from Plan 01 into the deployment pipeline and provide operational configs for production restart-on-crash.
Output: Documented .env.example, Gunicorn-based deploy target, systemd and launchd supervisor configs.
Research basis: 02-RESEARCH.md — .env.example code example, justfile deploy target pattern, systemd/launchd code examples.
</objective>

<execution_context>
@.planning/milestones/v0.1.0/phases/02-environment-and-wsgi-foundation/02-RESEARCH.md
@.planning/milestones/v0.1.0/phases/02-environment-and-wsgi-foundation/02-01-SUMMARY.md
</execution_context>

<context>
@.planning/codebase/STACK.md
@backend/gunicorn.conf.py
@justfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .env.example with all documented environment variables</name>
  <files>backend/.env.example</files>
  <action>
    Create `backend/.env.example` documenting every environment variable used in the codebase. The research (02-RESEARCH.md Code Examples section) provides the template. Audit all `os.environ.get()` calls in `backend/app/` to ensure completeness.

    Known env vars from codebase audit:
    - `SECRET_KEY` — Flask session signing key (string, no default — falls back to .secret_key file)
    - `GUNICORN_BIND` — Gunicorn bind address (string, default: "0.0.0.0:20000")
    - `LOG_LEVEL` — Logging level (string, default: "info", options: debug/info/warning/error/critical)
    - `CORS_ALLOWED_ORIGINS` — Comma-separated allowed origins (string, default: * — insecure)
    - `AGENTED_DB_PATH` — SQLite database path (string, default: backend/agented.db)
    - `GITHUB_WEBHOOK_SECRET` — HMAC-SHA256 webhook verification secret (string, no default)
    - `ANTHROPIC_API_KEY` — Anthropic API key for direct API access (string, no default)
    - `ANTHROPIC_API_BASE` — API base URL for proxy setups (string, no default)
    - `CLAUDE_PLUGIN_ROOT` — Path to GRD CLI binary directory (string, no default)
    - `STALE_CONVERSATION_THRESHOLD_SECS` — Stale conversation cleanup threshold (int, default: 1800)
    - `STALE_EXECUTION_THRESHOLD_SECS` — Stale execution cleanup threshold (int, default: 900)
    - `SSE_REPLAY_LIMIT` — SSE replay buffer size (int, default: 500)
    - `TZ` — Timezone override (string, no default — uses system timezone)
    - `SKILLS_PLAYGROUND_CWD` — Working directory for skills playground (string, no default)
    - `CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS` — Enable experimental agent teams feature (0 or 1, default: unset)

    Format each variable with:
    1. Section header comment (e.g., "# --- Security ---")
    2. Description comment explaining what it does
    3. Type and default in the description
    4. Variable name commented out with default value (or empty if no default)

    Group into logical sections: Security, Server, CORS, Database, GitHub, AI/LLM, Plugins, Tuning, Experimental.

    Place the file at `backend/.env.example` (same directory as run.py).
  </action>
  <verify>
    1. `test -f backend/.env.example && echo "exists"` prints "exists" (Level 1: Sanity)
    2. For each key env var, verify it appears: `grep -c "SECRET_KEY\|GUNICORN_BIND\|CORS_ALLOWED_ORIGINS\|AGENTED_DB_PATH\|GITHUB_WEBHOOK_SECRET\|ANTHROPIC_API_KEY\|LOG_LEVEL" backend/.env.example` returns >= 7 (Level 1: Sanity)
    3. File has section headers for organization (Level 1: Sanity)
  </verify>
  <done>
    .env.example exists at backend/.env.example, documents all 15+ environment variables with types, defaults, and descriptions organized into logical sections. A developer can `cp .env.example .env` and have a functional starting point.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update justfile deploy target to use Gunicorn and add process supervisor configs</name>
  <files>justfile, deploy/agented.service, deploy/com.agented.backend.plist</files>
  <action>
    **Step A — Update justfile deploy target:**

    Change the `deploy` recipe in `justfile` to use Gunicorn instead of `python run.py`. The current deploy recipe is:

    ```just
    deploy: kill ensure-backend build
        @echo "Starting backend on port 20000 and frontend on port 3000..."
        @echo "Frontend: http://localhost:3000"
        @echo "Backend API: http://localhost:20000"
        @echo ""
        cd backend && uv run python run.py &
        cd frontend && npm run dev
    ```

    Replace the `cd backend && uv run python run.py &` line with:
    ```just
        cd backend && uv run gunicorn -c gunicorn.conf.py &
    ```

    Also update the echo message to mention Gunicorn:
    ```just
        @echo "Starting backend via Gunicorn on port 20000..."
    ```

    Keep the `kill` and `ensure-backend` and `build` dependencies. Keep the frontend `npm run dev` line unchanged.

    Do NOT modify `dev-backend` — that should continue to use `python run.py --debug` for development with the Werkzeug reloader.

    **Step B — Create deploy/agented.service (systemd unit file for Linux):**

    Create directory `deploy/` at the project root. Create `deploy/agented.service` following the 02-RESEARCH.md Code Example:

    ```ini
    # Agented Backend — systemd unit file
    # Install: sudo cp deploy/agented.service /etc/systemd/system/
    # Enable:  sudo systemctl enable agented
    # Start:   sudo systemctl start agented
    # Logs:    journalctl -u agented -f
    #
    # Adjust WorkingDirectory and User/Group for your environment.
    # The ExecStart path assumes the backend venv is at .venv/ inside WorkingDirectory.

    [Unit]
    Description=Agented Backend API Server (Gunicorn + gevent)
    After=network.target

    [Service]
    Type=notify
    User=agented
    Group=agented
    WorkingDirectory=/opt/agented/backend
    Environment="PATH=/opt/agented/backend/.venv/bin:/usr/local/bin:/usr/bin"
    ExecStart=/opt/agented/backend/.venv/bin/gunicorn -c gunicorn.conf.py
    ExecReload=/bin/kill -s HUP $MAINPID
    Restart=on-failure
    RestartSec=3
    KillMode=mixed
    TimeoutStopSec=30

    [Install]
    WantedBy=multi-user.target
    ```

    Key points:
    - `Restart=on-failure` + `RestartSec=3` ensures restart within 5 seconds of crash (success criterion 5)
    - `Type=notify` — Gunicorn supports systemd notify protocol
    - `KillMode=mixed` — sends SIGTERM to main process (master), SIGKILL to remaining after TimeoutStopSec

    **Step C — Create deploy/com.agented.backend.plist (launchd plist for macOS):**

    Create `deploy/com.agented.backend.plist` following the 02-RESEARCH.md Code Example:

    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
      "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
    <!--
      Agented Backend — launchd plist for macOS
      Install: cp deploy/com.agented.backend.plist ~/Library/LaunchAgents/
      Load:    launchctl load ~/Library/LaunchAgents/com.agented.backend.plist
      Unload:  launchctl unload ~/Library/LaunchAgents/com.agented.backend.plist
      Logs:    tail -f /var/log/agented/backend.log

      Adjust ProgramArguments and WorkingDirectory for your environment.
    -->
    <plist version="1.0">
    <dict>
        <key>Label</key>
        <string>com.agented.backend</string>
        <key>ProgramArguments</key>
        <array>
            <string>/opt/agented/backend/.venv/bin/gunicorn</string>
            <string>-c</string>
            <string>gunicorn.conf.py</string>
        </array>
        <key>WorkingDirectory</key>
        <string>/opt/agented/backend</string>
        <key>KeepAlive</key>
        <true/>
        <key>RunAtLoad</key>
        <true/>
        <key>StandardOutPath</key>
        <string>/var/log/agented/backend.log</string>
        <key>StandardErrorPath</key>
        <string>/var/log/agented/backend-error.log</string>
    </dict>
    </plist>
    ```

    Key points:
    - `KeepAlive = true` ensures macOS restarts the process immediately on crash
    - `RunAtLoad = true` starts the service when the plist is loaded
    - Both supervisor configs reference `gunicorn -c gunicorn.conf.py` which points to the config from Plan 01
  </action>
  <verify>
    1. `grep "gunicorn" justfile` shows the deploy target uses gunicorn (Level 1: Sanity)
    2. `grep -v "python run.py" justfile | grep "deploy"` confirms python run.py is NOT in the deploy recipe (except dev-backend) (Level 1: Sanity)
    3. `test -f deploy/agented.service && echo "exists"` prints "exists" (Level 1: Sanity)
    4. `grep "Restart=on-failure" deploy/agented.service` matches (Level 1: Sanity)
    5. `grep "RestartSec=3" deploy/agented.service` matches — ensures restart within 5s (Level 1: Sanity)
    6. `test -f deploy/com.agented.backend.plist && echo "exists"` prints "exists" (Level 1: Sanity)
    7. `grep "KeepAlive" deploy/com.agented.backend.plist` matches (Level 1: Sanity)
    8. `just dev-backend` recipe still uses `python run.py --debug` (not Gunicorn) — verify dev workflow preserved (Level 1: Sanity)
  </verify>
  <done>
    justfile deploy target uses `uv run gunicorn -c gunicorn.conf.py` instead of `python run.py`. systemd service file exists at deploy/agented.service with Restart=on-failure and RestartSec=3. launchd plist exists at deploy/com.agented.backend.plist with KeepAlive=true. dev-backend recipe unchanged.
  </done>
</task>

</tasks>

<verification>
Level 1 (Sanity) — all checks for this plan:
1. `backend/.env.example` exists and documents all known env vars (15+ variables)
2. `justfile` deploy recipe references `gunicorn -c gunicorn.conf.py`
3. `justfile` dev-backend recipe still references `python run.py --debug`
4. `deploy/agented.service` exists with `Restart=on-failure` and `RestartSec=3`
5. `deploy/com.agented.backend.plist` exists with `KeepAlive` = true
6. `cd backend && uv run pytest` still passes (no regressions from justfile changes)
7. `cd frontend && npm run build` still passes
</verification>

<success_criteria>
.env.example documents all environment variables. `just deploy` uses Gunicorn. Both systemd and launchd supervisor configs exist with restart-on-crash semantics (restart within 5 seconds). The dev-backend workflow is preserved unchanged.
</success_criteria>

<output>
After completion, create `.planning/milestones/v0.1.0/phases/02-environment-and-wsgi-foundation/02-02-SUMMARY.md`
</output>
