---
phase: 03-api-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/__init__.py
  - backend/.env.example
autonomous: true
verification_level: sanity

must_haves:
  truths:
    - "Requests to /admin/* and /api/* without X-API-Key header return HTTP 401 when AGENTED_API_KEY is set"
    - "Requests to /admin/* and /api/* with valid X-API-Key header return HTTP 200"
    - "Bypass routes (/, /api/webhooks/github/, /health/*, /docs/*, /openapi/*) respond without 401 regardless of API key"
    - "OPTIONS preflight requests bypass auth (return CORS headers, never 401)"
    - "When AGENTED_API_KEY is not set, all routes remain accessible (auth disabled for backward compatibility)"
    - "CORS rejects cross-origin requests when CORS_ALLOWED_ORIGINS is empty or unset (fail-closed, no Access-Control-Allow-Origin header)"
    - "X-API-Key is listed in Access-Control-Allow-Headers for CORS preflight support"
    - "API key comparison uses hmac.compare_digest() for constant-time comparison"
  artifacts:
    - path: "backend/app/__init__.py"
      provides: "before_request auth middleware + CORS fail-closed config"
      contains: "before_request"
    - path: "backend/.env.example"
      provides: "AGENTED_API_KEY documentation"
      contains: "AGENTED_API_KEY"
  key_links:
    - from: "backend/app/__init__.py"
      to: "os.environ AGENTED_API_KEY"
      via: "env var read in before_request hook"
      pattern: "AGENTED_API_KEY"
---

<objective>
Add API key authentication middleware and CORS lockdown to the Flask backend.

Purpose: Protect all /admin/* and /api/* routes with API key validation while preserving unauthenticated access to webhooks, health probes, and docs. Harden CORS from permissive wildcard to fail-closed posture.

Output: Modified `backend/app/__init__.py` with `before_request` auth hook and updated CORS config; updated `backend/.env.example` with `AGENTED_API_KEY` documentation.

Research basis: Flask `before_request` is the canonical middleware pattern (Flask official docs). `hmac.compare_digest()` prevents timing attacks (Python stdlib). Flask-CORS empty origins list = reject all cross-origin (Flask-CORS docs, Context7). See 03-RESEARCH.md Recommendations 1 and 4.
</objective>

<execution_context>
@.claude/agents/grd-executor.md
</execution_context>

<context>
@.planning/milestones/v0.1.0/ROADMAP.md
@.planning/milestones/v0.1.0/phases/03-api-authentication/03-RESEARCH.md
@backend/app/__init__.py
@backend/.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add before_request API key authentication middleware</name>
  <files>backend/app/__init__.py</files>
  <action>
    Inside `create_app()` in `backend/app/__init__.py`, add a `@app.before_request` hook that enforces API key authentication. Place it after the CORS setup and before blueprint registration (after line 83, before line 85).

    The hook must:
    1. Import `hmac` and `request`, `jsonify` from flask at the top of the function (or module level).
    2. Strip trailing slash from `request.path` for consistent matching.
    3. Skip auth for `OPTIONS` requests (CORS preflight must not be blocked).
    4. Skip auth for bypass paths:
       - Exact matches: `""` (root webhook, path after rstrip("/")), `"/api/webhooks/github"`
       - Prefix matches: `"/health"`, `"/docs"`, `"/openapi"`
    5. Only enforce auth on paths starting with `"/admin"` or `"/api"` — all other paths (static files, SPA catch-all) pass through.
    6. Read `AGENTED_API_KEY` from `os.environ.get("AGENTED_API_KEY", "")`.
    7. If no key is configured (empty string), return `None` — auth is disabled for backward compatibility.
    8. Read the request key from `request.headers.get("X-API-Key", "")`.
    9. Compare using `hmac.compare_digest(request_key, api_key)` — constant-time to prevent timing attacks (Python stdlib, recommended by 03-RESEARCH.md).
    10. If key is missing or invalid, return `jsonify({"error": "Unauthorized"}), 401`.

    IMPORTANT: The `before_request` function must be defined INSIDE `create_app()` using the `@app.before_request` decorator, not as a standalone function. This ensures it has access to the Flask app context.

    IMPORTANT: Do NOT add `import hmac` inside the before_request function — add it at the module level alongside the existing `import os` and `import secrets`.

    AVOID: Per-route decorators (error-prone with 44+ blueprints, per 03-RESEARCH.md anti-patterns). AVOID `==` for key comparison (timing attack vulnerability, per 03-RESEARCH.md Common Implementation Traps).
  </action>
  <verify>
    cd backend && uv run pytest (Level 1: Sanity — existing tests must still pass with auth disabled by default)

    Then manually verify the middleware logic is correct by reading the code:
    - `@app.before_request` decorator is present
    - Bypass paths include `/`, `/api/webhooks/github/`, `/health/*`, `/docs/*`, `/openapi/*`
    - OPTIONS method is bypassed
    - `hmac.compare_digest` is used (not `==`)
    - Auth is disabled when AGENTED_API_KEY is empty
  </verify>
  <done>
    before_request hook exists in create_app(), all existing tests pass (auth disabled when no key set), bypass allowlist covers webhooks/health/docs/openapi, OPTIONS bypassed, hmac.compare_digest used for key comparison.
  </done>
</task>

<task type="auto">
  <name>Task 2: CORS fail-closed configuration and env documentation</name>
  <files>backend/app/__init__.py, backend/.env.example</files>
  <action>
    **Part A — CORS lockdown in `backend/app/__init__.py`:**

    Modify the existing CORS configuration block (lines 72-83) to:
    1. Change the fallback from `{"origins": "*"}` to `{"origins": []}` when `CORS_ALLOWED_ORIGINS` is empty or unset. This is a one-line change:
       ```python
       # BEFORE:
       cors_config = {"origins": allowed_origins} if allowed_origins else {"origins": "*"}
       # AFTER:
       cors_config = {"origins": allowed_origins} if allowed_origins else {"origins": []}
       ```
    2. Add `allow_headers=["Content-Type", "X-API-Key"]` to the `CORS()` call. This is required because `X-API-Key` is a custom header that triggers CORS preflight — without this, browsers will block all requests that include the auth header (per 03-RESEARCH.md Pitfall 3).
    3. Keep `r"/health/*": {"origins": "*"}` and `r"/docs/*": {"origins": "*"}` unchanged — health probes and Swagger UI must remain accessible cross-origin.

    **Part B — Document AGENTED_API_KEY in `backend/.env.example`:**

    Add a new section `# --- API Authentication ---` near the top of the file (after the `# --- Security ---` section which contains SECRET_KEY). Add:
    ```
    # --- API Authentication ---
    # API key for authenticating /admin/* and /api/* requests (string, no default)
    # When set, all admin/API requests must include X-API-Key header with this value.
    # When unset, authentication is disabled (all routes accessible without key).
    # AGENTED_API_KEY=
    ```

    AVOID: Setting CORS to `"*"` as fallback (the current insecure default). AVOID: Omitting `X-API-Key` from `allow_headers` (would silently break all frontend requests after auth is enabled, per 03-RESEARCH.md Pitfall 3).
  </action>
  <verify>
    cd backend && uv run pytest (Level 1: Sanity — tests pass with updated CORS config)

    Verify by reading code:
    - CORS fallback is `{"origins": []}` not `{"origins": "*"}`
    - `allow_headers=["Content-Type", "X-API-Key"]` is in CORS() call
    - `backend/.env.example` contains `AGENTED_API_KEY` with description
  </verify>
  <done>
    CORS fails closed when CORS_ALLOWED_ORIGINS is empty (origins=[]), X-API-Key is in CORS allow_headers, .env.example documents AGENTED_API_KEY with usage description, all tests pass.
  </done>
</task>

</tasks>

<verification>
Level 1 (Sanity):
- `cd backend && uv run pytest` passes (auth disabled by default, no regressions)
- Code inspection confirms `@app.before_request` hook with bypass allowlist
- Code inspection confirms CORS `{"origins": []}` fallback (not `"*"`)
- Code inspection confirms `allow_headers=["Content-Type", "X-API-Key"]`
- Code inspection confirms `hmac.compare_digest` (not `==`)
- `backend/.env.example` contains `AGENTED_API_KEY` entry

Level 2 (Proxy — deferred to Plan 02 integration):
- `curl http://localhost:20000/admin/triggers` without key returns 401 (requires AGENTED_API_KEY set)
- `curl -H "X-API-Key: $KEY" http://localhost:20000/admin/triggers` returns 200
- `curl -H "Origin: https://evil.example.com" http://localhost:20000/admin/triggers` has no Access-Control-Allow-Origin header
</verification>

<success_criteria>
1. `cd backend && uv run pytest` exits 0 with all tests passing
2. `backend/app/__init__.py` contains a `@app.before_request` function with API key validation, bypass allowlist, and OPTIONS bypass
3. CORS configuration uses fail-closed `{"origins": []}` fallback
4. `X-API-Key` is in CORS `allow_headers`
5. `backend/.env.example` documents `AGENTED_API_KEY`
</success_criteria>

<output>
After completion, create `.planning/milestones/v0.1.0/phases/03-api-authentication/03-01-SUMMARY.md`
</output>
